import { EGDESK_CONFIG } from './egdesk.config';

/**
 * EGDesk User Data Helper Functions for Next.js
 *
 * Type-safe helpers for accessing EGDesk user data.
 * Works in both client and server components.
 *
 * Generated by @egdesk/next-api-plugin
 */

/**
 * Call EGDesk user-data MCP tool
 *
 * Server: calls EGDesk API directly (so API routes work without going through the proxy).
 * Client: uses /__user_data_proxy so CORS and tunnel base path work.
 */
export async function callUserDataTool(
  toolName: string,
  args: Record<string, any> = {}
): Promise<any> {
  const isServer = typeof window === 'undefined';
  const headers: Record<string, string> = {
    'Content-Type': 'application/json'
  };

  let url: string;
  const body = JSON.stringify({ tool: toolName, arguments: args });

  if (isServer) {
    url = `${EGDESK_CONFIG.apiUrl}/user-data/tools/call`;
    if (EGDESK_CONFIG.apiKey) {
      headers['X-Api-Key'] = EGDESK_CONFIG.apiKey;
    }
  } else {
    url = '/__user_data_proxy';
  }

  const response = await fetch(url, {
    method: 'POST',
    headers,
    body
  });

  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
  }

  const result = await response.json();

  if (!result.success) {
    throw new Error(result.error || 'Tool call failed');
  }

  // Parse MCP response format
  const content = result.result?.content?.[0]?.text;
  return content ? JSON.parse(content) : null;
}

/**
 * Query table data
 */
export async function queryTable(
  tableName: string,
  options: {
    filters?: Record<string, string>;
    limit?: number;
    offset?: number;
    orderBy?: string;
    orderDirection?: 'ASC' | 'DESC';
  } = {}
) {
  return callUserDataTool('user_data_query', {
    tableName,
    ...options
  });
}

/**
 * Search table
 */
export async function searchTable(
  tableName: string,
  searchQuery: string,
  limit: number = 50
) {
  return callUserDataTool('user_data_search', {
    tableName,
    searchQuery,
    limit
  });
}

/**
 * Aggregate data
 */
export async function aggregateTable(
  tableName: string,
  column: string,
  aggregateFunction: 'SUM' | 'AVG' | 'MIN' | 'MAX' | 'COUNT',
  options: {
    filters?: Record<string, string>;
    groupBy?: string;
  } = {}
) {
  return callUserDataTool('user_data_aggregate', {
    tableName,
    column,
    function: aggregateFunction,
    ...options
  });
}

/**
 * Execute raw SQL query
 */
export async function executeSQL(query: string) {
  return callUserDataTool('user_data_sql_query', { query });
}

/**
 * List all available tables
 */
export async function listTables() {
  return callUserDataTool('user_data_list_tables', {});
}

/**
 * Get table schema
 */
export async function getTableSchema(tableName: string) {
  return callUserDataTool('user_data_get_schema', { tableName });
}
