/**
 * EGDesk User Data Helper Functions for Next.js
 *
 * Type-safe helpers for accessing EGDesk user data.
 * Works in both client and server components.
 *
 * Generated by @egdesk/next-api-plugin
 */

/**
 * Call EGDesk user-data MCP tool
 *
 * Uses a proxy endpoint to work in both local and tunneled environments.
 * The Next.js middleware intercepts these requests and forwards them to localhost:8080.
 */
export async function callUserDataTool(
  toolName: string,
  args: Record<string, any> = {}
): Promise<any> {
  const headers: Record<string, string> = {
    'Content-Type': 'application/json'
  };

  // Use proxy endpoint - works in both local and tunneled environments
  // Absolute URL with leading slash to ensure correct resolution from any route
  const response = await fetch('/__user_data_proxy', {
    method: 'POST',
    headers,
    body: JSON.stringify({ tool: toolName, arguments: args })
  });

  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
  }

  const result = await response.json();

  if (!result.success) {
    throw new Error(result.error || 'Tool call failed');
  }

  // Parse MCP response format
  const content = result.result?.content?.[0]?.text;
  return content ? JSON.parse(content) : null;
}

/**
 * Query table data
 */
export async function queryTable(
  tableName: string,
  options: {
    filters?: Record<string, string>;
    limit?: number;
    offset?: number;
    orderBy?: string;
    orderDirection?: 'ASC' | 'DESC';
  } = {}
) {
  return callUserDataTool('user_data_query', {
    tableName,
    ...options
  });
}

/**
 * Search table
 */
export async function searchTable(
  tableName: string,
  searchQuery: string,
  limit: number = 50
) {
  return callUserDataTool('user_data_search', {
    tableName,
    searchQuery,
    limit
  });
}

/**
 * Aggregate data
 */
export async function aggregateTable(
  tableName: string,
  column: string,
  aggregateFunction: 'SUM' | 'AVG' | 'MIN' | 'MAX' | 'COUNT',
  options: {
    filters?: Record<string, string>;
    groupBy?: string;
  } = {}
) {
  return callUserDataTool('user_data_aggregate', {
    tableName,
    column,
    function: aggregateFunction,
    ...options
  });
}

/**
 * Execute raw SQL query
 */
export async function executeSQL(query: string) {
  return callUserDataTool('user_data_sql_query', { query });
}

/**
 * List all available tables
 */
export async function listTables() {
  return callUserDataTool('user_data_list_tables', {});
}

/**
 * Get table schema
 */
export async function getTableSchema(tableName: string) {
  return callUserDataTool('user_data_get_schema', { tableName });
}
